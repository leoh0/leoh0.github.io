
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Mac os x - nslookup, host, dig works with /etc/resolv.conf, but ping, ssh doesnt work - > /dev/null</title>
	<meta name="author" content="leoh0">

	
	<meta name="description" content="Mac os x 는 linux와 다른 resolving을 제공한다. 간단하게만 이야기 하면 /etc/resolv.conf 외에도 /etc/resolver/* 에 원하는 dns명을 기록해 놓으면 해당 domain name을 갖을시 해당하는 nameserver로 쿼리를 &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="> /dev/null&#8221; type=&#8221;application/atom+xml&#8221;>
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">> /dev/null</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:leoh0.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		<a class="google" href="https://plus.google.com/104543023220946300714?rel=author" title="Google+">Google+</a>
		
		
		
		<a class="github" href="https://github.com/leoh0" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:leoh0.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">Mac Os X - Nslookup, Host, Dig Works With /etc/resolv.conf, but Ping, Ssh Doesnt Work</h2>
	<div class="entry-content"><p><img src="/images/2016-05-17_03-24-13.jpg" width="650" height="167"></p>

<p>Mac os x 는 linux와 다른 resolving을 제공한다.</p>

<p>간단하게만 이야기 하면 /etc/resolv.conf 외에도 /etc/resolver/* 에 원하는 dns명을 기록해 놓으면 해당 domain name을 갖을시 해당하는 nameserver로 쿼리를 할 수가 있다.</p>

<p>예를 들어 아래와 같이 설정했다면 *.local 과 같은 도메인은 10.10.1.65로 dns 서버를 사용가능하다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/resolver/local
</span><span class='line'>nameserver 10.10.1.65</span></code></pre></td></tr></table></div></figure>


<p>다만 이건 nslookup, host, dig 와 같은 dns lookup command 들에서는 나타나지 않는다. 이런 커맨드는 linux와 같이 /etc/resolv.conf 의 dns 서버를 이용해서 lookup을 하게 된다. (/etc/hosts 도..)</p>

<p>아무튼 이 설명은 아래 커맨드 들의 man page를 보면 알수 있다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ man dig
</span><span class='line'>...
</span><span class='line'>Mac OS X NOTICE
</span><span class='line'>       The dig command does not use the host name and address resolution or the DNS query routing mechanisms used by other processes running on Mac OS X.  The results of name or address queries printed by dig may
</span><span class='line'>       differ from those found by other processes that use the Mac OS X native name and address resolution mechanisms.  The results of DNS queries may also differ from queries that use the Mac OS X DNS routing
</span><span class='line'>       library.
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ man nslookup
</span><span class='line'>...
</span><span class='line'>Mac OS X NOTICE
</span><span class='line'>       The nslookup command does not use the host name and address resolution or the DNS query routing mechanisms used by other processes running on Mac OS X.  The results of name or address queries printed by
</span><span class='line'>       nslookup may differ from those found by other processes that use the Mac OS X native name and address resolution mechanisms.  The results of DNS queries may also differ from queries that use the Mac OS X DNS
</span><span class='line'>       routing library.
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ man host
</span><span class='line'>...
</span><span class='line'>Mac OS X NOTICE
</span><span class='line'>       The host command does not use the host name and address resolution or the DNS query routing mechanisms used by other processes running on Mac OS X.  The results of name or address queries printed by host may
</span><span class='line'>       differ from those found by other processes that use the Mac OS X native name and address resolution mechanisms.  The results of DNS queries may also differ from queries that use the Mac OS X DNS routing
</span><span class='line'>       library.
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>하지만 ssh, ping은 /etc/resolver/* 외에도 설정되어 있는 resolver dns 로 쿼리를 하게 된다. 그렇기 때문에 한쪽에서는(nslookup, dig, host) 되고 한쪽(ping, ssh 외 다수)에서는 안되는 케이스가 발생한다.</p>

<p>그렇다면 이것을 어떻게 확인 할 수 있을까?  <br/>
가장 간단한 방법은 아래와 같다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ scutil --dns</span></code></pre></td></tr></table></div></figure>


<p>결과는 아래와 같이 resolver 들과 그들의 순위(order)를 확인 할 수 있다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ scutil --dns
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>resolver #2
</span><span class='line'>  domain   : 1015140824.members.btmm.icloud.com
</span><span class='line'>  options  : pdns
</span><span class='line'>  timeout  : 5
</span><span class='line'>  flags    : Request A records
</span><span class='line'>Not Reachable
</span><span class='line'>  order    : 150000
</span><span class='line'>
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>resolver #4
</span><span class='line'>  domain   : local
</span><span class='line'>  options  : mdns
</span><span class='line'>  timeout  : 5
</span><span class='line'>  flags    : Request A records
</span><span class='line'>Not Reachable
</span><span class='line'>  order    : 300000
</span><span class='line'>
</span><span class='line'>resolver #5
</span><span class='line'>  domain   : 254.169.in-addr.arpa
</span><span class='line'>  options  : mdns
</span><span class='line'>  timeout  : 5
</span><span class='line'>  flags    : Request A records
</span><span class='line'>Not Reachable
</span><span class='line'>  order    : 300200
</span><span class='line'>
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>사족으로 여기에서도 만약에 local 순위가 300000(default) 가 마음에 안들면 아래와 같이 resolver 에 추가 하면 100000으로 변경이 가능하다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/resolver/local
</span><span class='line'>nameserver 10.10.1.65
</span><span class='line'>search_order 100000</span></code></pre></td></tr></table></div></figure>


<p>이런 설정이 일반적으로는 필요하지 않지만 아래와 같은 vpn을 사용하는 케이스에서 발생했었다.</p>

<p>우선 아래와 같은 커맨드로 /etc/resolv.conf 에 원하는 search domain들을 network interface 당 추가가 가능하다. (아니면 환경 설정에서 추가..)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo networksetup -setsearchdomains 'WI-FI' local</span></code></pre></td></tr></table></div></figure>


<p>이러면 대략 아래와 같이 local 을 search 구문으로 사용가능하다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/resolv.conf
</span><span class='line'>...
</span><span class='line'>search local
</span><span class='line'>nameserver 8.8.8.8</span></code></pre></td></tr></table></div></figure>


<p>일반적으로 이렇게 사용하는게 문제가 되지 않지만 만약 junos pulse 같은 vpn을 사용시 vpn에서 주어주는 search domain이 아닐시 자신의 기존 search domain 들은 원래 nameserver로 가도록 설정되어 있다.</p>

<p>예를 들면 이렇다.</p>

<p>A, B 라는 search domain을 (가)라는 dns를 사용하는데
만약 vpn에서 B, C 라는 search domain을 (나)라는 dns로 주어지면
아래와 같이 정리된다.</p>

<p>A, B, C search domain을 사용하는 것은 default 로 (나) 로 사용되나.  <br/>
이것보다 높은 order 로 A 가 (가)로 한개 더 설정된다.</p>

<p>이런 케이스에는 A domain은 (나)로 질의 하고 싶어도 (가)로 질의 하게 되는 문제가 있다.</p>

<p>vpn 측에서 모든 search domain을 내려주면 해결할 수 있지만 이런게 힘들 시에는 <a href="https://gist.github.com/b4ldr/f9d6aab4837ae18d908f">여기</a> <a href="http://diaryproducts.net/about/operating_systems/mac_os_x/overriding_dhcp_or_vpn_assigned_dns_servers_in_mac_os_x_leopard">여기</a> 와 같이 직접 scutil 을 통해서 VPN의 DNS 값들을 수정해 줄 수 있다. (아니면 위와 같이 /etc/resolver/local 과 같이 파일을 만들어도 됨)</p>

<p>추가적으로 아래와 같은 커맨드로 debugging 을 가능하다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># enable operation logging.
</span><span class='line'>sudo killall -USR1 mDNSResponder
</span><span class='line'>
</span><span class='line'># enable packet logging.
</span><span class='line'>sudo killall -USR2 mDNSResponder
</span><span class='line'>
</span><span class='line'># clear the DNS cache.
</span><span class='line'>sudo killall -HUP mDNSResponder
</span><span class='line'>
</span><span class='line'># dump mDNSRepsonder's internal state.
</span><span class='line'>sudo killall -INFO mDNSResponder</span></code></pre></td></tr></table></div></figure>


<p>졸려서 두서없이 정리함..
나중에 다시 좀더 자세하게 정리를..</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2016-05-17T02:24:09+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/dig/'>dig</a>, <a class='category' href='/blog/categories/dns/'>dns</a>, <a class='category' href='/blog/categories/host/'>host</a>, <a class='category' href='/blog/categories/junos-pulse/'>junos pulse</a>, <a class='category' href='/blog/categories/mac/'>mac</a>, <a class='category' href='/blog/categories/nslookup/'>nslookup</a>, <a class='category' href='/blog/categories/ping/'>ping</a>, <a class='category' href='/blog/categories/resolver/'>resolver</a>, <a class='category' href='/blog/categories/ssh/'>ssh</a>, <a class='category' href='/blog/categories/vpn/'>vpn</a>


</div>
	
	<div class="comments"><a href="#disqus_thread">Comments</a></div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
		
		
		<a class="addthis_button_tweet"></a>
		
		
		
	</div>
	
</div>



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2018

    leoh0

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'leoh0githubio';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://leoh0.github.io/blog/2016/05/17/mac-os-x-nslookup/';
        var disqus_url = 'http://leoh0.github.io/blog/2016/05/17/mac-os-x-nslookup/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-46519012-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>