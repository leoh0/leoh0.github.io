
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>> /dev/null</title>
	<meta name="author" content="leoh0">

	
	<meta name="description" content="우선 아래와 같은 컨피그를 이용할때.. nova linuxnet_interface_driver = nova.network.linux_net.LinuxOVSInterfaceDriver neutron type_drivers = vlan
mechanism_drivers &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="> /dev/null&#8221; type=&#8221;application/atom+xml&#8221;>
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">> /dev/null</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:leoh0.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		<a class="google" href="https://plus.google.com/104543023220946300714?rel=author" title="Google+">Google+</a>
		
		
		
		<a class="github" href="https://github.com/leoh0" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:leoh0.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/02/02/make-l2-network-for-vm-without-neutron/">
		
			Make L2 Network for Vm Without Neutron</a>
	</h2>
	<div class="entry-content">
		<p>우선 아래와 같은 컨피그를 이용할때..</p>

<h2>nova</h2>

<ul>
<li>linuxnet_interface_driver = nova.network.linux_net.LinuxOVSInterfaceDriver</li>
</ul>


<h2>neutron</h2>

<ul>
<li>type_drivers = vlan</li>
<li>mechanism_drivers = openvswitch</li>
<li>firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver</li>
</ul>


<h2>1. 기본 상태:</h2>

<p>우선 실제 물리 머신에 아래와 같이 vm을 위한 ethernet인 eth1이 존재한다.</p>

<p><img src="/images/neutron-nova-network-1.jpg" width="497" height="395"></p>

<h3>변수 생성</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">vmuuid</span><span class="o">=</span>9ee8db25-6a13-4ca8-8a4e-495db24492ca
</span><span class='line'><span class="nv">vlan</span><span class="o">=</span>2001
</span><span class='line'><span class="nv">localvlan</span><span class="o">=</span>1
</span><span class='line'><span class="nv">ip</span><span class="o">=</span><span class="k">$(</span>nova show <span class="nv">$vmuuid</span> <span class="p">|</span> grep <span class="s1">&#39; network&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $5}&#39;</span><span class="k">)</span>
</span><span class='line'><span class="nv">interfaceid</span><span class="o">=</span><span class="k">$(</span>neutron port-list <span class="p">|</span> grep <span class="s2">&quot;\&quot;$ip\&quot;&quot;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
</span><span class='line'><span class="nv">mac</span><span class="o">=</span><span class="k">$(</span>neutron port-list <span class="p">|</span> grep <span class="s2">&quot;\&quot;$ip\&quot;&quot;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $5}&#39;</span><span class="k">)</span>
</span><span class='line'><span class="nv">ovsid</span><span class="o">=</span><span class="k">${</span><span class="nv">interfaceid</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">11</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>2. 유저 생성 단계:</h2>

<p>eth1에 연결된 br-eth1 bridge를 생성한다.
또한 gre, vlan등의 다양한 type들의 네트워크를 연결시켜 줄 수 있는 br-int bridge를 생성한다.</p>

<p><img src="/images/neutron-nova-network-2.jpg" width="497" height="395"></p>

<h3>user가 생성 필요</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ovs-vsctl --timeout<span class="o">=</span><span class="m">10</span> -- --may-exist add-br br-eth1
</span><span class='line'>ovs-vsctl --timeout<span class="o">=</span><span class="m">10</span> -- --may-exist add-port br-eth1 eth1
</span></code></pre></td></tr></table></div></figure>


<h2>3. neutron openvswitch plugin 시작:</h2>

<p>br-eth1과 br-int간의 bridge 연결을 위한 port를 생성하며 veth로 해당 port를 연결하고 해당 bridge에 기본적인 flow를 추가해 준다.</p>

<p><img src="/images/neutron-nova-network-3.jpg" width="497" height="395"></p>

<h3>neutron - br-int setup</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ovs-vsctl --timeout<span class="o">=</span><span class="m">10</span> -- --may-exist add-br br-int
</span><span class='line'>ovs-vsctl --timeout<span class="o">=</span><span class="m">10</span> -- <span class="nb">set</span>-fail-mode br-int secure
</span><span class='line'>ovs-vsctl --timeout<span class="o">=</span><span class="m">10</span> -- --if-exists del-port br-int patch-tun
</span><span class='line'>ovs-ofctl del-flows br-int
</span><span class='line'>ovs-ofctl add-flow br-int <span class="nv">hard_timeout</span><span class="o">=</span>0,idle_timeout<span class="o">=</span>0,priority<span class="o">=</span>1,actions<span class="o">=</span>normal
</span><span class='line'>ovs-ofctl add-flow br-int <span class="nv">hard_timeout</span><span class="o">=</span>0,idle_timeout<span class="o">=</span>0,priority<span class="o">=</span>0,table<span class="o">=</span>22,actions<span class="o">=</span>drop
</span></code></pre></td></tr></table></div></figure>


<h3>neutron - physical bridge setup</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ovs-ofctl del-flows br-eth1
</span><span class='line'>ovs-ofctl add-flow br-eth1 <span class="nv">hard_timeout</span><span class="o">=</span>0,idle_timeout<span class="o">=</span>0,priority<span class="o">=</span>1,actions<span class="o">=</span>normal
</span></code></pre></td></tr></table></div></figure>


<h3>neutron - int <-> phy setup</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ovs-vsctl --timeout<span class="o">=</span><span class="m">10</span> -- --if-exists del-port br-int int-br-eth1
</span><span class='line'>ovs-vsctl --timeout<span class="o">=</span><span class="m">10</span> -- --if-exists del-port br-eth1 phy-br-eth1
</span><span class='line'>ip link delete int-br-eth1
</span><span class='line'>ip link delete phy-br-eth1
</span><span class='line'>udevadm settle --timeout<span class="o">=</span>10
</span><span class='line'>ip link add int-br-eth1 <span class="nb">type </span>veth peer name phy-br-eth1
</span><span class='line'>ovs-vsctl --timeout<span class="o">=</span><span class="m">10</span> -- --may-exist add-port br-int int-br-eth1
</span><span class='line'>ovs-vsctl --timeout<span class="o">=</span><span class="m">10</span> -- --may-exist add-port br-eth1 phy-br-eth1
</span><span class='line'><span class="nv">intport</span><span class="o">=</span><span class="k">$(</span>ovs-ofctl show br-int <span class="p">|</span> grep int-br-eth1 <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span> <span class="p">|</span> cut -d<span class="s1">&#39;(&#39;</span> -f1<span class="k">)</span>
</span><span class='line'><span class="nv">phyport</span><span class="o">=</span><span class="k">$(</span>ovs-ofctl show br-eth1 <span class="p">|</span> grep phy-br-eth1 <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span> <span class="p">|</span> cut -d<span class="s1">&#39;(&#39;</span> -f1<span class="k">)</span>
</span><span class='line'>ovs-ofctl add-flow br-int <span class="nv">hard_timeout</span><span class="o">=</span>0,idle_timeout<span class="o">=</span>0,priority<span class="o">=</span>2,in_port<span class="o">=</span><span class="k">${</span><span class="nv">intport</span><span class="k">}</span>,actions<span class="o">=</span>drop
</span><span class='line'>ovs-ofctl add-flow br-eth1 <span class="nv">hard_timeout</span><span class="o">=</span>0,idle_timeout<span class="o">=</span>0,priority<span class="o">=</span>2,in_port<span class="o">=</span><span class="k">${</span><span class="nv">phyport</span><span class="k">}</span>,actions<span class="o">=</span>drop
</span><span class='line'>ip link <span class="nb">set </span>int-br-eth1 up
</span><span class='line'>ip link <span class="nb">set </span>phy-br-eth1 up
</span></code></pre></td></tr></table></div></figure>


<h2>4. nova에서 인스턴스 생성:</h2>

<p>nova에서는 qbr bridge를 생성하며 해당 bridge에 qvb port를 생성하고 br-int에 qvo port를 생성하여 두 port를 veth로 연결한다.(xml에 관련해서 여기에서 생성된다.)</p>

<p><img src="/images/neutron-nova-network-4.jpg" width="497" height="395"></p>

<h3>nova - instance up</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brctl addbr qbr<span class="k">${</span><span class="nv">ovsid</span><span class="k">}</span>
</span><span class='line'>brctl setfd qbr<span class="k">${</span><span class="nv">ovsid</span><span class="k">}</span> 0
</span><span class='line'>brctl stp qbr<span class="k">${</span><span class="nv">ovsid</span><span class="k">}</span> off
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;0&#39;</span> &gt; /sys/class/net/qbr<span class="k">${</span><span class="nv">ovsid</span><span class="k">}</span>/bridge/multicast_snooping
</span><span class='line'>
</span><span class='line'>ip link add qvb<span class="k">${</span><span class="nv">ovsid</span><span class="k">}</span> <span class="nb">type </span>veth peer name qvo<span class="k">${</span><span class="nv">ovsid</span><span class="k">}</span>
</span><span class='line'>ip link <span class="nb">set </span>qvb<span class="k">${</span><span class="nv">ovsid</span><span class="k">}</span> up
</span><span class='line'>ip link <span class="nb">set </span>qvb<span class="k">${</span><span class="nv">ovsid</span><span class="k">}</span> promisc on
</span><span class='line'>ip link <span class="nb">set </span>qvo<span class="k">${</span><span class="nv">ovsid</span><span class="k">}</span> up
</span><span class='line'>ip link <span class="nb">set </span>qvo<span class="k">${</span><span class="nv">ovsid</span><span class="k">}</span> promisc on
</span><span class='line'>
</span><span class='line'>ip link <span class="nb">set </span>qbr<span class="k">${</span><span class="nv">ovsid</span><span class="k">}</span> up
</span><span class='line'>brctl addif qbr<span class="k">${</span><span class="nv">ovsid</span><span class="k">}</span> qvb<span class="k">${</span><span class="nv">ovsid</span><span class="k">}</span>
</span><span class='line'>ovs-vsctl --timeout<span class="o">=</span><span class="m">120</span> -- --if-exists del-port qvo<span class="k">${</span><span class="nv">ovsid</span><span class="k">}</span> -- add-port br-int qvo<span class="k">${</span><span class="nv">ovsid</span><span class="k">}</span> -- <span class="nb">set </span>Interface qvo<span class="k">${</span><span class="nv">ovsid</span><span class="k">}</span> external-ids:iface-id<span class="o">=</span><span class="k">${</span><span class="nv">interfaceid</span><span class="k">}</span> external-ids:iface-status<span class="o">=</span>active external-ids:attached-mac<span class="o">=</span><span class="k">${</span><span class="nv">mac</span><span class="k">}</span> external-ids:vm-uuid<span class="o">=</span><span class="k">${</span><span class="nv">vmuuid</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>5. neutron openvswitch plugin에서 ovsdb-client monitoring을 통한 풀링:</h2>

<p>br-int의 변화를 감지하여 해당 qvo port를 위한 vlan tagging을 해주며 이를 위한 flow를 br-int와 br-eth1에 추가한다.</p>

<p><img src="/images/neutron-nova-network-5.jpg" width="497" height="395"></p>

<h3>neutron - instance up</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ovs-ofctl add-flow br-int <span class="nv">hard_timeout</span><span class="o">=</span>0,idle_timeout<span class="o">=</span>0,priority<span class="o">=</span>3,in_port<span class="o">=</span><span class="k">${</span><span class="nv">intport</span><span class="k">}</span>,dl_vlan<span class="o">=</span><span class="k">${</span><span class="nv">vlan</span><span class="k">}</span>,actions<span class="o">=</span>mod_vlan_vid:<span class="k">${</span><span class="nv">localvlan</span><span class="k">}</span>,normal
</span><span class='line'>ovs-ofctl add-flow br-eth1 <span class="nv">hard_timeout</span><span class="o">=</span>0,idle_timeout<span class="o">=</span>0,priority<span class="o">=</span>4,in_port<span class="o">=</span><span class="k">${</span><span class="nv">phyport</span><span class="k">}</span>,dl_vlan<span class="o">=</span><span class="k">${</span><span class="nv">localvlan</span><span class="k">}</span>,actions<span class="o">=</span>mod_vlan_vid:<span class="k">${</span><span class="nv">vlan</span><span class="k">}</span>,normal
</span><span class='line'>
</span><span class='line'>ovs-vsctl --timeout<span class="o">=</span><span class="m">10</span> <span class="nb">set </span>Port qvo<span class="k">${</span><span class="nv">ovsid</span><span class="k">}</span> <span class="nv">tag</span><span class="o">=</span><span class="k">${</span><span class="nv">localvlan</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>6. vm 부팅:</h2>

<p>vm이 시작하면서  libvirt의 xml파일안에 정의 되어 있는 qbr bridge에 tap port가 생성되어서 vm까지 네트워크가 완성된다.(이 xml은 이미 4번 단계에서 완성되어 있다.)</p>

<p><img src="/images/neutron-nova-network-6.jpg" width="497" height="395"></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-02-02T09:20:23+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/neutron/'>neutron</a>, <a class='category' href='/blog/categories/openstack/'>openstack</a>, <a class='category' href='/blog/categories/openvswitch/'>openvswitch</a>, <a class='category' href='/blog/categories/ovs/'>ovs</a>


</div>
	
	<div class="comments"><a href="/blog/2015/02/02/make-l2-network-for-vm-without-neutron/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/01/16/jiogyi-ceph-rbd-image-format-2-data-recovering/">
		
			Ceph Pg Incomplete: Rbd Image-format 2 Data Recovery</a>
	</h2>
	<div class="entry-content">
		<h2>ceph: pg incomplete is worst nightmare</h2>

<p><img src="http://a1.res.cloudinary.com/hqq9ey1mh/image/upload/c_limit,w_793/v1414983220/z3vn1zndif6v7q2u08w1.png" width="500" height="500" title="&#34;2014 open user survey block storage&#34;" alt="&#34;2014 open user survey block storage&#34;"></p>

<p><a href="http://superuser.openstack.org/articles/openstack-user-survey-insights-november-2014">2014년 유저 설문조사</a>에서 찾을 수 있듯이 <strong>ceph</strong>은 openstack의 block storage의 de facto standard 라고 말할 수 있다.</p>

<p>ceph을 사용한지 조금 되었지만 큰 문제가 한번도 없어서 일명 <strong>믿음의 ceph</strong>이라고 칭송하며 내부구조도 살필일 없이 블랙박스로 두고 잘 쓰고 있었었다.</p>

<p>하지만 근래에 급작스런 몇가지 문제로 ceph의 <code>placement group(pg)</code> 들이 <code>incomplete</code> 상태로 떨어졌고..</p>

<p>말그대로 절망했다.</p>

<p>왜냐하면 <code>incomplete</code> 상태로 떨어진 pg들이 절대 다른 상태로 돌아올수 없으며 해당 pg에 접근하는 모든 request는 slow request화 되며 응답을 주지 않는다. 그렇기 때문에 해당 pg가 있는 pool은 모든 request가 hang에 걸릴 수 있게 되어 pool 전체가 사용불능 상태로 변하게 된다.</p>

<h2>incomplete?</h2>

<p>조금 더 <code>incomplete</code>가 어떤 상태인지를 잠깐 이해해야 할것 같다. 우선 <code>incomplete</code>의 정의를 살펴보면 ceph documents의 <a href="http://ceph.com/docs/master/rados/operations/pg-states/">pg-states</a>에서 찾아볼 수 있다.</p>

<blockquote><p>Ceph detects that a placement group is missing a necessary period of history from its log.
If you see this state, report a bug, and try to start any failed OSDs that may contain the needed information.</p></blockquote>

<p>즉, 해당 pg 가 log에서 특정 부분 히스토리를 잃어 버렸을때 발생하는 것이고, 만약 이 일이 일어나면 해당 정보를 가지고 있을만한 실패한 OSD들을 시작하라고 설명이 되어 있다.(버그 리포트는 덤..)   <br/>
그래서 위의 설명처럼 <code>incomplete</code> 상태는 OSD를 중지했을때도 잠깐 발생할 수 있는데 여기서 말하는 <code>incomplete</code>는 그런게 아니라 무슨짓을 해도 다시 <code>incomplete</code>로 돌아오는 상태를 말한다..</p>

<p>이 의미를 조금 더 의미있게 해석하면 pg가 <code>incomplete</code> 상태로 떨어졌을때 <code>peering</code>을 할 수 있는 상태로 돌아오지 못한다는 것은 이미 복구 불가능한 pg가 생겼고 이는 복구 불가능한 조각이 생겼다는 것을 의미한다. <br/>
그러므로 전체 파일중 특정 조각이 문제가 되고 이 파일을 접근하는 모든 client request는 hang이 걸리게 된다. <br/>
볼륨같은 큰 데이터(많은 조각을 갖는 데이터)는 몇 개의 pg만 <code>incomplete</code>로 떨어져도 결국 모든 client의 request가 hang이 걸리게 된다.</p>

<p><img src="/images/ceph.png" width="1688" height="264" title="&#34;ceph logical flow&#34;" alt="&#34;ceph logical flow&#34;"></p>

<p>그러므로 <code>incomplete</code> 된 pg가 있으면 pool 전체를 사용할 수 가 없다.(pool을 초기화 하기 전까지..) <br/>
왜냐하면 어떠한 rbd object는 rados object로 분할되고 rados object들은 해당 pool에 분할 되어져서 들어간다. <br/>
해당 pool은 pg 들로 이루어 지는데 그중 한 pg 조각만 문제가 있어도 그 pg 조각에 들어간 한 rados object에 접근이 안되고 그렇기 때문에 rbd object 자체를 쓸수가 없게 되기 때문에 해당 pool을 쓸 수 없게 된다. <br/>
온갖 메일링 리스트와 구글에서 검색한 방법을 사용했지만 효과는 없었고 <br/>
다음에 이 상태로 빠지지 않을 수 있는 교훈만 얻을 수 있었다.</p>

<p>이 글을 보면 이게 얼마나 간단하지 않은 일인지 알게 된다.. <br/>
<a href="https://www.mail-archive.com/ceph-users@lists.ceph.com/msg15916.html">Ceph PG Incomplete = Cluster unusable</a></p>

<p>현재로서는 여기 <a href="http://tracker.ceph.com/issues/10098">feature 요청</a> 같이 데이터를 포기하더라도 pg를 재생성할 수 있는 기능이 추가되기를 기대해야 하는 상황이다. <br/>
(현재는 <code>ceph pg force_create_pg</code>를 사용해도 <code>creating</code> 상태에서 <code>incomplete</code> 상태로 되돌아 온다..)</p>

<p>물론 이상태까지 오게 하지 않는게 최선의 방법이지만 이미 이런 복구 불가능한 데이터가 생기면 <br/>
그리고 그 데이터가 볼륨인데 pg 한조각이 유실되면 해당 데이터를 사용할 수 없게 된다.(read write중 hang) <br/>
그렇기 때문에 결국 이런 볼륨을 살려내기 위해서는 강제로 볼륨 데이터를 <code>export</code>하고 이를 바탕으로 새로운 풀을 제작해서 다시 <code>import</code>할 수 밖에 없다.<br/>
물론 볼륨 데이터를 <code>export</code> 하면 hang이 걸려서 이 내용과 같이 특수한 방법이 필요하다.</p>

<p>그래서 오늘의 주제는 <code>incomplete</code> 와 같이 pool 전체를 사용할 수 없는 상태에서 최대한 데이터를 복구해 내는 방법을 소개하고자 한다.</p>

<h2>image format</h2>

<p>우선 이 방법을 이해하기 위해서는 기본적으로 <code>rbd image format</code>을 이해해야한다. <br/>
우선 <a href="http://blog.bit-isle.jp/bird/2014/06/10">Ceph 아키텍처 해설</a>에서 기본적인 지식을 습득할 수 있다. <br/>
우선 <code>rbd image format</code>의 종류는 아래와 같이 2가지 종류이고 위의 글에서 2가지 포맷의 제한점을 알 수 있다.</p>

<h3>rbd image format 1</h3>

<figure class='code'><figcaption><span>ceph/src/include/rbd_types.h</span><a href='https://github.com/ceph/ceph/blob/master/src/include/rbd_types.h#L36-46'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * old-style rbd image &#39;foo&#39; consists of objects</span>
</span><span class='line'><span class="cm"> *   foo.rbd      - image metadata</span>
</span><span class='line'><span class="cm"> *   rb.&lt;idhi&gt;.&lt;idlo&gt;.00000000</span>
</span><span class='line'><span class="cm"> *   rb.&lt;idhi&gt;.&lt;idlo&gt;.00000001</span>
</span><span class='line'><span class="cm"> *   ...          - data</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define RBD_SUFFIX       &quot;.rbd&quot;</span>
</span><span class='line'><span class="cp">#define RBD_DIRECTORY           &quot;rbd_directory&quot;</span>
</span><span class='line'><span class="cp">#define RBD_INFO                &quot;rbd_info&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>rbd image format 2</h3>

<figure class='code'><figcaption><span>ceph/src/include/rbd_types.h</span><a href='https://github.com/ceph/ceph/blob/master/src/include/rbd_types.h#L24-34'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* New-style rbd image &#39;foo&#39; consists of objects</span>
</span><span class='line'><span class="cm"> *   rbd_id.foo              - id of image</span>
</span><span class='line'><span class="cm"> *   rbd_header.&lt;id&gt;         - image metadata</span>
</span><span class='line'><span class="cm"> *   rbd_data.&lt;id&gt;.00000000</span>
</span><span class='line'><span class="cm"> *   rbd_data.&lt;id&gt;.00000001</span>
</span><span class='line'><span class="cm"> *   ...                     - data</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define RBD_HEADER_PREFIX      &quot;rbd_header.&quot;</span>
</span><span class='line'><span class="cp">#define RBD_DATA_PREFIX        &quot;rbd_data.&quot;</span>
</span><span class='line'><span class="cp">#define RBD_ID_PREFIX          &quot;rbd_id.&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>우선 이글은 현재 사용중인 <code>rbd image format 2</code>의 포맷의 복구 방법에 대해서 설명할 계획이다.</p>

<h2>image format 2 분석</h2>

<p>만약 당신이 glance나 cinder를 사용중이라면 uuid 형태의 이름을 갖는 image와 volume들이 있을 것이다. <br/>
이 정보는 ceph rbd 안에서는 아래와 같이 조회 가능하다.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># rbd -p images ls</span>
</span><span class='line'>08909734-66fa-48e3-ab5e-2e2b8bb3a58c
</span></code></pre></td></tr></table></div></figure>


<p>위와 같이 image나 volume이 사용하고 있는 pool의 list를 조회해 보면 uuid 들이 나오는데 이 리스트 데이터들이 실제 image와 volume의 uuid 이다.
그렇다면 이런 image와 volume을 조회하면 다음과 같다.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># rbd -p images info 08909734-66fa-48e3-ab5e-2e2b8bb3a58c</span>
</span><span class='line'>rbd image <span class="s1">&#39;08909734-66fa-48e3-ab5e-2e2b8bb3a58c&#39;</span>:
</span><span class='line'>    size <span class="m">810</span> MB in <span class="m">102</span> objects
</span><span class='line'>    order <span class="m">23</span> <span class="o">(</span><span class="m">8192</span> kB objects<span class="o">)</span>
</span><span class='line'>    block_name_prefix: rbd_data.5a57484353d0cd
</span><span class='line'>    format: 2
</span><span class='line'>    features: layering
</span></code></pre></td></tr></table></div></figure>


<p>이 내용은 실제 rbd에 저장된 uuid의 데이터가 어떤지 정보를 보여주는데 <br/>
여기에서 <code>08909734-66fa-48e3-ab5e-2e2b8bb3a58c</code> 라는 uuid의 이미지는 <code>810 MB</code>의 크기를 가지며 <code>102</code>개의 조각이다. <br/>
그리고 <code>2**23=8192kB</code>의 크기로 쪼개져 있다. 즉, <code>810 MB</code>는 <code>약 8192kB * 102</code> 이다. <br/>
다음으로 <code>block_name_prefix: rbd_data.5a57484353d0cd</code>에서 <code>5a57484353d0cd</code>가 prefix 값이다. <br/>
format: 2 는 말그대로 image format 2 이고 features은 default값이다.</p>

<p>rbd는 rados object들로 이루어져 있으며 위의 정보를 바탕으로 아래와 같이 3종류의 object로 구성된다.</p>

<ul>
<li><strong>rbd_id.08909734-66fa-48e3-ab5e-2e2b8bb3a58c</strong></li>
<li><strong>rbd_header.5a57484353d0cd</strong></li>
<li><strong>rbd_data.5a57484353d0cd.0000000000000000 ~ rbd_data.5a57484353d0cd.0000000000000021 (102개)</strong></li>
</ul>


<h3>rbd_id.08909734-66fa-48e3-ab5e-2e2b8bb3a58c</h3>

<p>rbd_id.&lt;uuid> 파일을 다운받아서 열어보면 그 안에 <code>prefix</code> 값이 저장되어 있는 것을 알 수 있다. <br/>
저 값은 random 값이 들어 있어서 이 방법이 아니면 찾을 수가 없는 값이다.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># cat rbd_id.08909734-66fa-48e3-ab5e-2e2b8bb3a58c</span>
</span><span class='line'>5a57484353d0cd
</span></code></pre></td></tr></table></div></figure>


<h3>rbd_header.5a57484353d0cd</h3>

<p>rbd_header.&lt;prefix> 파일은 아무것도 내용이 없다. 실제 파일 내용이며 xattr 정보도 쓸만 한게 없다. <br/>
하지만 이정보는 파일로 관리하기 위해 존재하는 가상의 정보이지 실제는 leveldb에 저장되어 있다.(구버전은 테스트를 못해서 구버전엔 xattr을 썻을 지도..)
아무튼 이 안에서 features, object_prefix, order, size, snap_seq 를 뽑아 낼 수 있다.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># rados listomapvals -p images rbd_header.5a57484353d0cd</span>
</span><span class='line'>features
</span><span class='line'>value: <span class="o">(</span><span class="m">8</span> bytes<span class="o">)</span> :
</span><span class='line'><span class="m">0000</span> : <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>                         : ........
</span><span class='line'>object_prefix
</span><span class='line'>value: <span class="o">(</span><span class="m">27</span> bytes<span class="o">)</span> :
</span><span class='line'><span class="m">0000</span> : <span class="m">17</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">72</span> <span class="m">62</span> <span class="m">64</span> 5f <span class="m">64</span> <span class="m">61</span> <span class="m">74</span> <span class="m">61</span> 2e <span class="m">35</span> <span class="m">61</span> <span class="m">35</span> : ....rbd_data.5a5
</span><span class='line'><span class="m">0010</span> : <span class="m">37</span> <span class="m">34</span> <span class="m">38</span> <span class="m">34</span> <span class="m">33</span> <span class="m">35</span> <span class="m">33</span> <span class="m">64</span> <span class="m">30</span> <span class="m">63</span> <span class="m">64</span>                : 7484353d0cd
</span><span class='line'>order
</span><span class='line'>value: <span class="o">(</span><span class="m">1</span> bytes<span class="o">)</span> :
</span><span class='line'><span class="m">0000</span> : <span class="m">17</span>                                              : .
</span><span class='line'>size
</span><span class='line'>value: <span class="o">(</span><span class="m">8</span> bytes<span class="o">)</span> :
</span><span class='line'><span class="m">0000</span> : <span class="m">00</span> 8c a3 <span class="m">32</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>                         : ...2....
</span><span class='line'>snap_seq
</span><span class='line'>value: <span class="o">(</span><span class="m">8</span> bytes<span class="o">)</span> :
</span><span class='line'><span class="m">0000</span> : <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>                         : ........
</span></code></pre></td></tr></table></div></figure>


<h3>rbd_data.5a57484353d0cd.0000000000000000 ~ rbd_data.5a57484353d0cd.0000000000000021 (102개)</h3>

<p>실제 데이터이며 이 정보를 이어 붙이면 우리가 원하는 데이터를 얻을 수 있다. <br/>
하지만 이 정보 들은 존재하지 않는 파일들도 있을 수도 있다.(안쓰는 블럭부분의 오브젝트는 생성안되어 있음)
아무튼 뒤의 16진수 16자리 개수 만큼 데이터를 생성할 수 있다.
우리는 102개의 오브젝트 인걸 알고 있으니 0000000000000000 ~ 0000000000000021 까지해서 102개 이다.</p>

<h4>Q. 왜 <code>rados -p image ls</code> 같은 커맨드로 오브젝트의 정확한 리스트를 검사하지 않는가?</h4>

<p>만약 incomplete 상태가 되면 <code>rados ls</code> 같은 커맨드는 incomplete 인 pg 에 request 를 던지고 그 request는 hang이 되기때문에 응답을 받기가 힘들것이다.. <br/>
그렇기 때문에 이런 작업으로 실제 존재할 데이터를 추정해야 한다.</p>

<h2>작업 순서</h2>

<p>image나 volume 의 <code>uuid</code>이름과 <code>pool</code>의 이름을 알고 있으면 시작할 수 있다.</p>

<h3>1. pool 이름 -> pool 번호, pg 개수</h3>

<p>아래와 같은 정보에서 보면 <code>pool 35</code>와 <code>pg_num 512</code> 정보로 pool 번호가 <code>35</code>인것 그리고 pg 개수가 <code>512</code> 인것을 알 수 있다.
추가로 <code>object_hash rjenkins</code>로 <code>rjenkins</code> 해쉬를 사용함을 알 수 있다.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># ceph osd dump</span>
</span><span class='line'>...
</span><span class='line'>pool <span class="m">35</span> <span class="s1">&#39;images&#39;</span> replicated size <span class="m">2</span> min_size <span class="m">1</span> crush_ruleset <span class="m">0</span> object_hash rjenkins pg_num <span class="m">512</span> pgp_num <span class="m">512</span> last_change <span class="m">46681</span> flags hashpspool stripe_width 0
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<h3>2. rbd -p &lt;pool> info &lt;uuid> -> prefix, 파일 개수, 사이즈</h3>

<p>앞에서 한번 설명했지만 다시 정리하면 아래와 같은 상황에서 prefix는 <code>5a57484353d0cd</code> 파일 개수는 <code>102</code> 파일 사이즈는 <code>8192 kB</code> 이다.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># rbd -p images info 08909734-66fa-48e3-ab5e-2e2b8bb3a58c</span>
</span><span class='line'>rbd image <span class="s1">&#39;08909734-66fa-48e3-ab5e-2e2b8bb3a58c&#39;</span>:
</span><span class='line'>    size <span class="m">810</span> MB in <span class="m">102</span> objects
</span><span class='line'>    order <span class="m">23</span> <span class="o">(</span><span class="m">8192</span> kB objects<span class="o">)</span>
</span><span class='line'>    block_name_prefix: rbd_data.5a57484353d0cd
</span><span class='line'>    format: 2
</span><span class='line'>    features: layering
</span></code></pre></td></tr></table></div></figure>


<p>물론 incomplete pg에 해당 header가 들어 있다면.. 그 파일은 포기해야 한다.</p>

<h3>3. rbd_data.&lt;prefix>.&lt;seq> 파일 찾기</h3>

<p>실제 데이터는 rbd_data.&lt;prefix>.&lt;seq> 파일을 연결하면 복구 할 수 있다.
그렇다면 어떻게 저 파일들을 찾을 수 있을까..</p>

<p>우선 아래 커맨드로 찾을 수 있다. 저 아래정보에서 <code>-&gt;</code> 뒤편의 정보를 참고 하면 된다. <br/>
pg 35.9f6e4c67 는 35번 풀의 9f6e4c67 해쉬 값을 갖는 데이터를 말하며 <br/>
9f6e4c67 값이 rbd_data.b0e882ae8944a.0000000000000134 를 해쉬 한 값이다. <br/>
그렇다면 67은 무엇이냐면 9f6e4c67 를 pg_num으로 <code>modular</code> 연산 해서 나온 값이다. <br/>
우리는 실제 디렉토리는 35.67을 사용하니까 저 값을 알 고 있으면 된다. <br/>
또한 뒤의 up 3,11 에서 3번 osd 11번 osd가 가지고 있는 것을 알 수 있다.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># ceph osd map images rbd_data.b0e882ae8944a.0000000000000134</span>
</span><span class='line'>osdmap e53074 pool <span class="s1">&#39;images&#39;</span> <span class="o">(</span>35<span class="o">)</span> object <span class="s1">&#39;rbd_data.b0e882ae8944a.0000000000000134&#39;</span> -&gt; pg 35.9f6e4c67 <span class="o">(</span>35.67<span class="o">)</span> -&gt; up <span class="o">([</span>3,11<span class="o">]</span>, p3<span class="o">)</span> acting <span class="o">([</span>3,11<span class="o">]</span>, p3<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>다만 <code>ceph osd map ..</code> 커맨드는 <code>ceph pg dump</code> 와 같은 pg를 뒤져야 하는 부분이 있기 때문에 느릴 수 있다. <br/>
이때문에 이 기능은 아래와 같이 pg dump에 대한 내용을 파일로 저장하고 아래 같이 해쉬 스크립트만 따로 돌리는게 훨씬 빠를 것이다.</p>

<p>아래 python코드는 ceph에서 사용하는 <a href="http://burtleburtle.net/bob/hash/evahash.html">robert jenkins hash</a> 를 <a href="http://stackoverflow.com/a/3611698">포팅</a>한 스크립트 이다. <br/>
물론 rjenkins hash 아니면 linux hash이나 기본이 rjenkins hash 이다.</p>

<figure class='code'><figcaption><span>rjhash.py</span><a href='https://gist.github.com/leoh0/aac0bb046c49a108c541'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="sd">&#39;&#39;&#39;Implements a straight Jenkins lookup hash - http://burtleburtle.net/bob/hash/doobs.html</span>
</span><span class='line'>
</span><span class='line'><span class="sd">Usage: </span>
</span><span class='line'><span class="sd">    from jhash import jhash</span>
</span><span class='line'><span class="sd">    print jhash(&#39;My hovercraft is full of eels&#39;)</span>
</span><span class='line'>
</span><span class='line'><span class="sd">Returns: unsigned 32 bit integer value</span>
</span><span class='line'>
</span><span class='line'><span class="sd">Prereqs: None</span>
</span><span class='line'>
</span><span class='line'><span class="sd">Tested with Python 2.6.</span>
</span><span class='line'><span class="sd">Version 1.00 - der@dod.no - 23.08.2010</span>
</span><span class='line'>
</span><span class='line'><span class="sd">Partly based on the Perl module Digest::JHash</span>
</span><span class='line'><span class="sd">http://search.cpan.org/~shlomif/Digest-JHash-0.06/lib/Digest/JHash.pm</span>
</span><span class='line'>
</span><span class='line'><span class="sd">Original copyright notice:</span>
</span><span class='line'><span class="sd">    By Bob Jenkins, 1996.  bob_jenkins@burtleburtle.net.  You may use this</span>
</span><span class='line'><span class="sd">    code any way you wish, private, educational, or commercial.  It&#39;s free.</span>
</span><span class='line'>
</span><span class='line'><span class="sd">    See http://burtleburtle.net/bob/hash/evahash.html</span>
</span><span class='line'><span class="sd">    Use for hash table lookup, or anything where one collision in 2^^32 is</span>
</span><span class='line'><span class="sd">    acceptable.  Do NOT use for cryptographic purposes.</span>
</span><span class='line'><span class="sd">&#39;&#39;&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">mix</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&#39;&#39;&#39;mix() -- mix 3 32-bit values reversibly.</span>
</span><span class='line'><span class="sd">For every delta with one or two bits set, and the deltas of all three</span>
</span><span class='line'><span class="sd">  high bits or all three low bits, whether the original value of a,b,c</span>
</span><span class='line'><span class="sd">  is almost all zero or is uniformly distributed,</span>
</span><span class='line'><span class="sd">* If mix() is run forward or backward, at least 32 bits in a,b,c</span>
</span><span class='line'><span class="sd">  have at least 1/4 probability of changing.</span>
</span><span class='line'><span class="sd">* If mix() is run forward, every bit of c will change between 1/3 and</span>
</span><span class='line'><span class="sd">  2/3 of the time.  (Well, 22/100 and 78/100 for some 2-bit deltas.)&#39;&#39;&#39;</span>
</span><span class='line'>    <span class="c"># Need to constrain U32 to only 32 bits using the &amp; 0xffffffff </span>
</span><span class='line'>    <span class="c"># since Python has no native notion of integers limited to 32 bit</span>
</span><span class='line'>    <span class="c"># http://docs.python.org/library/stdtypes.html#numeric-types-int-float-long-complex</span>
</span><span class='line'>    <span class="n">a</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span> <span class="n">b</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span> <span class="n">c</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span>
</span><span class='line'>    <span class="n">a</span> <span class="o">-=</span> <span class="n">b</span><span class="p">;</span> <span class="n">a</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span> <span class="n">a</span> <span class="o">^=</span> <span class="p">(</span><span class="n">c</span><span class="o">&gt;&gt;</span><span class="mi">13</span><span class="p">);</span> <span class="n">a</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span>
</span><span class='line'>    <span class="n">b</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span> <span class="n">b</span> <span class="o">-=</span> <span class="n">a</span><span class="p">;</span> <span class="n">b</span> <span class="o">^=</span> <span class="p">(</span><span class="n">a</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span> <span class="n">b</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span>
</span><span class='line'>    <span class="n">c</span> <span class="o">-=</span> <span class="n">a</span><span class="p">;</span> <span class="n">c</span> <span class="o">-=</span> <span class="n">b</span><span class="p">;</span> <span class="n">c</span> <span class="o">^=</span> <span class="p">(</span><span class="n">b</span><span class="o">&gt;&gt;</span><span class="mi">13</span><span class="p">);</span> <span class="n">c</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span>
</span><span class='line'>    <span class="n">a</span> <span class="o">-=</span> <span class="n">b</span><span class="p">;</span> <span class="n">a</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span> <span class="n">a</span> <span class="o">^=</span> <span class="p">(</span><span class="n">c</span><span class="o">&gt;&gt;</span><span class="mi">12</span><span class="p">);</span> <span class="n">a</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span>
</span><span class='line'>    <span class="n">b</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span> <span class="n">b</span> <span class="o">-=</span> <span class="n">a</span><span class="p">;</span> <span class="n">b</span> <span class="o">^=</span> <span class="p">(</span><span class="n">a</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span> <span class="n">b</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span>
</span><span class='line'>    <span class="n">c</span> <span class="o">-=</span> <span class="n">a</span><span class="p">;</span> <span class="n">c</span> <span class="o">-=</span> <span class="n">b</span><span class="p">;</span> <span class="n">c</span> <span class="o">^=</span> <span class="p">(</span><span class="n">b</span><span class="o">&gt;&gt;</span><span class="mi">5</span><span class="p">);</span> <span class="n">c</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span>
</span><span class='line'>    <span class="n">a</span> <span class="o">-=</span> <span class="n">b</span><span class="p">;</span> <span class="n">a</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span> <span class="n">a</span> <span class="o">^=</span> <span class="p">(</span><span class="n">c</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">);</span> <span class="n">a</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span>
</span><span class='line'>    <span class="n">b</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span> <span class="n">b</span> <span class="o">-=</span> <span class="n">a</span><span class="p">;</span> <span class="n">b</span> <span class="o">^=</span> <span class="p">(</span><span class="n">a</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">);</span> <span class="n">b</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span>
</span><span class='line'>    <span class="n">c</span> <span class="o">-=</span> <span class="n">a</span><span class="p">;</span> <span class="n">c</span> <span class="o">-=</span> <span class="n">b</span><span class="p">;</span> <span class="n">c</span> <span class="o">^=</span> <span class="p">(</span><span class="n">b</span><span class="o">&gt;&gt;</span><span class="mi">15</span><span class="p">);</span> <span class="n">c</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">jhash</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">initval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&#39;&#39;&#39;hash() -- hash a variable-length key into a 32-bit value</span>
</span><span class='line'><span class="sd">  data    : the key (the unaligned variable-length array of bytes)</span>
</span><span class='line'><span class="sd">  initval : can be any 4-byte value, defaults to 0</span>
</span><span class='line'><span class="sd">Returns a 32-bit value.  Every bit of the key affects every bit of</span>
</span><span class='line'><span class="sd">the return value.  Every 1-bit and 2-bit delta achieves avalanche.&#39;&#39;&#39;</span>
</span><span class='line'>    <span class="n">length</span> <span class="o">=</span> <span class="n">lenpos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># empty string returns 0</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Set up the internal state</span>
</span><span class='line'>    <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="mh">0x9e3779b9</span> <span class="c"># the golden ratio; an arbitrary value</span>
</span><span class='line'>    <span class="n">c</span> <span class="o">=</span> <span class="n">initval</span>        <span class="c"># the previous hash value</span>
</span><span class='line'>    <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c"># string offset</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># ------------------------- handle most of the key in 12 byte chunks</span>
</span><span class='line'>    <span class="k">while</span> <span class="n">lenpos</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">:</span>
</span><span class='line'>        <span class="n">a</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">))</span>
</span><span class='line'>        <span class="n">b</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">6</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">7</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">))</span>
</span><span class='line'>        <span class="n">c</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">8</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">9</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">10</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">11</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">))</span>
</span><span class='line'>        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span class='line'>        <span class="n">p</span> <span class="o">+=</span> <span class="mi">12</span>
</span><span class='line'>        <span class="n">lenpos</span> <span class="o">-=</span> <span class="mi">12</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># ------------------------- handle the last 11 bytes</span>
</span><span class='line'>    <span class="n">c</span> <span class="o">+=</span> <span class="n">length</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">lenpos</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">:</span> <span class="n">c</span> <span class="o">+=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">10</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">24</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">lenpos</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span> <span class="n">c</span> <span class="o">+=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">9</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">16</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">lenpos</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">:</span>  <span class="n">c</span> <span class="o">+=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">8</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">8</span>
</span><span class='line'>    <span class="c"># the first byte of c is reserved for the length</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">lenpos</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>  <span class="n">b</span> <span class="o">+=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">7</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">24</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">lenpos</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>  <span class="n">b</span> <span class="o">+=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">6</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">16</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">lenpos</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>  <span class="n">b</span> <span class="o">+=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">8</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">lenpos</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>  <span class="n">b</span> <span class="o">+=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">lenpos</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>  <span class="n">a</span> <span class="o">+=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">24</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">lenpos</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>  <span class="n">a</span> <span class="o">+=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">16</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">lenpos</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>  <span class="n">a</span> <span class="o">+=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">8</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">lenpos</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>  <span class="n">a</span> <span class="o">+=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">0</span><span class="p">])</span>
</span><span class='line'>    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># ------------------------- report the result</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">c</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">hashstr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>    <span class="n">myhash</span> <span class="o">=</span> <span class="n">jhash</span><span class="p">(</span><span class="n">hashstr</span><span class="p">)</span>
</span><span class='line'>    <span class="n">myhash2</span> <span class="o">=</span> <span class="n">myhash</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;</span><span class="si">%x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">myhash2</span>
</span></code></pre></td></tr></table></div></figure>


<p>즉, 위와 같이 스크립트로 해슁하면 <code>rbd_data.b0e882ae8944a.0000000000000134</code> 값이 <code>67</code> 임을 찾을 수 있을 것이다.
35번 pool 임을 알고 있으니 35.67 pg 인것을 확인 가능하다.
아래 같이 <code>ceph pg dump</code> 는 파일로 저장해서 사용하는 것이 훨씬 빠를 것이다.. (물론 클러스터 변화를 주지 않는 상태에서.. )</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># ceph pg dump &gt; /tmp/pgdump # just once</span>
</span><span class='line'>
</span><span class='line'><span class="c"># cat /tmp/pgdump | grep ^35.67</span>
</span><span class='line'>dumped all in format plain
</span><span class='line'>35.67 0   0   0   0   0   2   2   active+clean    2015-01-15 06:48:51.979426  46681   53074:6358  <span class="o">[</span>3,11<span class="o">]</span>    0   <span class="o">[</span>3,11<span class="o">]</span>    0   46681   2015-01-15 06:48:51.979318  46681   2015-01-14 06:47:33.392701
</span></code></pre></td></tr></table></div></figure>


<p>그렇다면 실제 데이터는 어디에 저장될까..
대략 기본적으로 아래와 같은 경로에 저장된다.</p>

<p>ceph-3 의 <code>3</code>은 osd 번호이며 <br/>
<code>35.67</code>_head 는 위에서 계산한 hash 값에 pg_num으로 modular한 값이다. <br/>
<code>DIR_7</code> <code>DIR_6</code> <code>DIR_C</code> 는 뒤의 <code>9F6E4C67</code> 의 suffix 역순이다.(이 디렉토리는 파일 개수에 따라 생기고 없어질수도 있다.) <br/>
물론 <code>9F6E4C67</code>는 아까의 hash 값이다. <br/>
마지막 __<code>23</code> 은 pool 번호 35의 16진수 값이다.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/var/lib/ceph/osd/ceph-3/current/35.67_head/DIR_7/DIR_6/DIR_C/rbd<span class="se">\u</span>data.b0e882ae8944a.0000000000000134__head_9F6E4C67__23
</span></code></pre></td></tr></table></div></figure>


<p>중간에 DIR 과 같은 디렉토리가 들어가야 하기때문에 결국 이 파일을 찾으려면 find로 찾는게 간편하다.</p>

<h3>4. 파일 합치기</h3>

<p>아래와 같은 스크립트를 참고하면 편하다. 간단하게 파일번호로 offset 계산해서 합치는 스크립트 이다.    <br/>
해당 스크립트는 로컬에 있는 파일리스트를 조회해서 합치는 것임으로 위에서 미리 찾아서 한 폴더로 몰아놓으면 편하다.</p>

<figure class='code'><figcaption><span>rbd_restore.sh</span><a href='https://raw.githubusercontent.com/smmoore/ceph/master/rbd_restore.sh'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># AUTHORS</span>
</span><span class='line'><span class="c"># Shawn Moore &lt;smmoore@catawba.edu&gt;</span>
</span><span class='line'><span class="c"># Rodney Rymer &lt;rrr@catawba.edu&gt;</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># REQUIREMENTS</span>
</span><span class='line'><span class="c"># GNU Awk (gawk)</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># NOTES</span>
</span><span class='line'><span class="c"># This utility assumes one copy of all object files needed to construct the rbd</span>
</span><span class='line'><span class="c"># are located in the present working direcory at the time of execution.  </span>
</span><span class='line'><span class="c"># For example all the rb.0.1032.5e69c215.* files.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># When listing the &quot;RBD_SIZE_IN_BYTES&quot;, be sure you list the full potential size, </span>
</span><span class='line'><span class="c"># not just what it appears to be. If you do not know the true size of the rbd,</span>
</span><span class='line'><span class="c"># you can input a size in bytes that you know is larger than the disk could be</span>
</span><span class='line'><span class="c"># and it will be a large sparse file with un-partioned space at the end of the</span>
</span><span class='line'><span class="c"># disk.  In our tests, this doesn&#39;t occupy any more space/objects in the cluster</span>
</span><span class='line'><span class="c"># but the rbd could be resized from within the rbd (VM) to grow.  Once you bring</span>
</span><span class='line'><span class="c"># it up and are able to find the true size, you can resize with &quot;rbd resize ..&quot;.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># To obtain needed utility input information if not already known run:</span>
</span><span class='line'><span class="c"># rbd info RBD</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># To find needed files we run the following command on all nodes that might have</span>
</span><span class='line'><span class="c"># copies of the rbd objects:</span>
</span><span class='line'><span class="c"># find /${CEPH} -type f -name rb.0.1032.5e69c215.*</span>
</span><span class='line'><span class="c"># Then copy the files to a single location from all nodes.  If using btrfs be</span>
</span><span class='line'><span class="c"># sure to pay attention to the btrfs snapshots that ceph takes on it&#39;s own.</span>
</span><span class='line'><span class="c"># You may want the &quot;current&quot; or one of the &quot;snaps&quot;.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># We are actually taking our own btrfs snapshots cluster osd wide at the same</span>
</span><span class='line'><span class="c"># time with parallel ssh and then using &quot;btrfs subvolume find-new&quot; command to</span>
</span><span class='line'><span class="c"># merge them all together for disaster recovery and also outside of ceph rbd</span>
</span><span class='line'><span class="c"># versioning.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Hopefully once the btrfs send/recv functionality is stable we can switch to it.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This utility works for us but may not for you.  Always test with non-critical</span>
</span><span class='line'><span class="c"># data first.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Rados object size</span>
</span><span class='line'><span class="nv">obj_size</span><span class="o">=</span>4194304
</span><span class='line'>
</span><span class='line'><span class="c"># DD bs value</span>
</span><span class='line'><span class="nv">rebuild_block_size</span><span class="o">=</span>512
</span><span class='line'>
</span><span class='line'><span class="nv">rbd</span><span class="o">=</span><span class="s2">&quot;${1}&quot;</span>
</span><span class='line'><span class="nv">base</span><span class="o">=</span><span class="s2">&quot;${2}&quot;</span>
</span><span class='line'><span class="nv">rbd_size</span><span class="o">=</span><span class="s2">&quot;${3}&quot;</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;${1}&quot;</span> <span class="o">=</span> <span class="s2">&quot;-h&quot;</span> -o <span class="s2">&quot;${1}&quot;</span> <span class="o">=</span> <span class="s2">&quot;--help&quot;</span> -o <span class="s2">&quot;${rbd}&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> -o <span class="s2">&quot;${base}&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> -o <span class="s2">&quot;${rbd_size}&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;USAGE: $(echo ${0} | awk -F/ &#39;{print $NF}&#39;) RESTORE_RBD BLOCK_PREFIX RBD_SIZE_IN_BYTES&quot;</span>
</span><span class='line'>  <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'><span class="nv">base_files</span><span class="o">=</span><span class="k">$(</span>ls -1 <span class="k">${</span><span class="nv">base</span><span class="k">}</span>.* 2&gt;/dev/null <span class="p">|</span> wc -l <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">base_files</span><span class="k">}</span> -lt <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;COULD NOT FIND FILES FOR ${base} IN $(pwd)&quot;</span>
</span><span class='line'>  <span class="nb">exit</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Create full size sparse image.  Could use truncate, but wanted</span>
</span><span class='line'><span class="c"># as few required files and dd what a must.</span>
</span><span class='line'>dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span><span class="k">${</span><span class="nv">rbd</span><span class="k">}</span> <span class="nv">bs</span><span class="o">=</span><span class="m">1</span> <span class="nv">count</span><span class="o">=</span><span class="m">0</span> <span class="nv">seek</span><span class="o">=</span><span class="k">${</span><span class="nv">rbd_size</span><span class="k">}</span> 2&gt;/dev/null
</span><span class='line'>
</span><span class='line'><span class="k">for</span> file_name in <span class="k">$(</span>ls -1 <span class="k">${</span><span class="nv">base</span><span class="k">}</span>.* 2&gt;/dev/null<span class="k">)</span><span class="p">;</span> <span class="k">do</span>
</span><span class='line'>  <span class="nv">seek_loc</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">file_name</span><span class="k">}</span> <span class="p">|</span> awk -F_ <span class="s1">&#39;{print $1}&#39;</span> <span class="p">|</span> awk -v <span class="nv">os</span><span class="o">=</span><span class="k">${</span><span class="nv">obj_size</span><span class="k">}</span> -v <span class="nv">rs</span><span class="o">=</span><span class="k">${</span><span class="nv">rebuild_block_size</span><span class="k">}</span> -F. <span class="s1">&#39;{print os*strtonum(&quot;0x&quot; $NF)/rs}&#39;</span><span class="k">)</span>
</span><span class='line'>  dd <span class="nv">conv</span><span class="o">=</span>notrunc <span class="k">if</span><span class="o">=</span><span class="k">${</span><span class="nv">file_name</span><span class="k">}</span> <span class="nv">of</span><span class="o">=</span><span class="k">${</span><span class="nv">rbd</span><span class="k">}</span> <span class="nv">seek</span><span class="o">=</span><span class="k">${</span><span class="nv">seek_loc</span><span class="k">}</span> <span class="nv">bs</span><span class="o">=</span><span class="k">${</span><span class="nv">rebuild_block_size</span><span class="k">}</span> 2&gt;/dev/null
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<h3>5. mount 해서 테스트 해보기</h3>

<p>아래 와 같이 loop device 를 이용해서 mount 해본다. <br/>
하지만 partition 테이블이 망가져서 <code>/dev/mapper/loop0p1</code>를 못쓰고 그냥 <code>/dev/loop0</code> device로 mount 해야 할 수 도 있다.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">v</span><span class="o">=</span><span class="s2">&quot;volume-uuid&quot;</span>
</span><span class='line'>losetup /dev/loop0 <span class="nv">$v</span>
</span><span class='line'>kpartx -a /dev/loop0
</span><span class='line'>mkdir -p /mnt/<span class="nv">$v</span>
</span><span class='line'>mount /dev/mapper/loop0p1 /mnt/<span class="nv">$v</span>
</span></code></pre></td></tr></table></div></figure>


<p>물론 들어가보면 엄청나게 많은 파일, 폴더들이 깨져 있으므로.. <code>fsck -y /mnt/$v</code> 와 같이 파일 시스템 체크를 돌려서 살려내는것이 필요하다.</p>

<h2>결론</h2>

<p>이런 정보를 바탕으로 우리는 3가지의 rados object들로 rbd 이미지를 재구성 할 수 있다. <br/>
하지만 이 방법은 운이 따라줘야 하는 부분들이 당연히 있다. <br/>
예를 들어 아래 pg 들이 망가지면 복구가 불가능 할 수도 있다.</p>

<ul>
<li>rbd_header 파일이 있는 pg</li>
<li>rbd_data에서 초반 super block이 있는 pg</li>
</ul>


<p>아무튼 이 글을 앞으로도 절망할 지 모르는 사람들을 위해 바친다.</p>

<h2>ps.</h2>

<p>마지막으로 firefly는 v0.80.8 package를 2015년 1월 13일에 release 했다. <br/>
업그레이드 하는게 좋을것이다.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-01-16T00:54:53+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/block-storage/'>block storage</a>, <a class='category' href='/blog/categories/ceph/'>ceph</a>, <a class='category' href='/blog/categories/incomplete/'>incomplete</a>, <a class='category' href='/blog/categories/openstack/'>openstack</a>, <a class='category' href='/blog/categories/pg/'>pg</a>


</div>
	
	<div class="comments"><a href="/blog/2015/01/16/jiogyi-ceph-rbd-image-format-2-data-recovering/#disqus_thread">Comments</a></div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/01/15/isa/">
		
			이사</a>
	</h2>
	<div class="entry-content">
		<p><del><strong>RIP</strong> 20140404 <a href="https://leoh0.wordpress.com">https://leoh0.wordpress.com</a></del> <br/>
<del><strong>RIP</strong> 20150115 <a href="http://leoh0.blogspot.kr">http://leoh0.blogspot.kr</a></del></p>

<p>제일 처음 wordpress 블로그를 썼을때 다 만족스러웠지만 왠지 구글 검색에 노출되는 시간이 오래 걸리는 기분이 있었다.. <br/>
그래서 blogspot 으로 옮겨 갔으나.. <br/>
하지만 부족한 템플릿과 플러그인.. <br/>
그리고 소스 코드 삽입시 html 코드를 작성해야하는데 이게 너무 지저분해서 맘에 들지 않았다.</p>

<p>그래서 결국 소스 코드를 가장 이쁘게 보여 줄 수 있는 <a href="octopress.org">octopress</a>로..</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-01-15T17:58:18+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/jabdam/'>잡담</a>


</div>
	
	<div class="comments"><a href="/blog/2015/01/15/isa/#disqus_thread">Comments</a></div>
	
</div>
</article>

<nav id="pagenavi">
    
        
            <a href="/posts/2" class="prev">Prev</a>
        
    
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2018

    leoh0

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'leoh0githubio';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-46519012-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>