
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>chef 12: node attribute style problem - feature or bug? - > /dev/null</title>
	<meta name="author" content="leoh0">

	
	<meta name="description" content="chef 12 client를 이용하면서 기존 recipe 들을 사용중 갑자기 작동 안하는 문제가 있었다. chef 12로 변화되며 추가된 기능인가 싶어 chef 12 release note를 뒤져보았지만 사실 관련된 부분을 찾지 못했다. 대략 현상은 아래와 같다.. &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="> /dev/null&#8221; type=&#8221;application/atom+xml&#8221;>
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<!-- javascript -->
<script type='text/javascript' src='https://cdn.rawgit.com/kandebonfim/show-your-terms/master/dist/show-your-terms.min.js'></script>
<!-- stylesheet -->
<link rel='stylesheet' href='https://cdn.rawgit.com/kandebonfim/show-your-terms/master/dist/show-your-terms.min.css'>

</head>


<body>
	<header id="header" class="inner"><h1><a href="/">> /dev/null</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:leoh0.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		<a class="google" href="https://plus.google.com/104543023220946300714?rel=author" title="Google+">Google+</a>
		
		
		
		<a class="github" href="https://github.com/leoh0" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:leoh0.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">Chef 12: Node Attribute Style Problem - Feature or Bug?</h2>
	<div class="entry-content"><p>chef 12 client를 이용하면서 기존 recipe 들을 사용중 갑자기 작동 안하는 문제가 있었다. <br/>
chef 12로 변화되며 추가된 기능인가 싶어 <a href="https://docs.chef.io/release_notes.html">chef 12 release note</a>를 뒤져보았지만 사실 관련된 부분을 찾지 못했다.</p>

<p>대략 현상은 아래와 같다..</p>

<figure class='code'><figcaption><span>chef12</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">chef</span> <span class="o">&gt;</span> <span class="n">attributes_mode</span>
</span><span class='line'><span class="ss">chef</span><span class="p">:</span><span class="n">attributes</span> <span class="o">&gt;</span> <span class="n">default</span><span class="o">[</span><span class="s1">&#39;haproxy&#39;</span><span class="o">][</span><span class="s1">&#39;conf_dir&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;aa&#39;</span>
</span><span class='line'><span class="ss">chef</span><span class="p">:</span><span class="n">attributes</span> <span class="o">&gt;</span> <span class="nb">puts</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;haproxy&#39;</span><span class="o">][</span><span class="s1">&#39;conf_dir&#39;</span><span class="o">]</span>
</span><span class='line'><span class="n">aa</span>
</span><span class='line'><span class="ss">chef</span><span class="p">:</span><span class="n">attributes</span> <span class="o">&gt;</span> <span class="nb">puts</span> <span class="n">node</span><span class="o">[</span><span class="ss">:haproxy</span><span class="o">][</span><span class="ss">:conf_dir</span><span class="o">]</span>
</span><span class='line'><span class="n">aa</span>
</span><span class='line'>
</span><span class='line'><span class="ss">chef</span><span class="p">:</span><span class="n">attributes</span> <span class="o">&gt;</span> <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="o">[</span><span class="s1">&#39;haproxy&#39;</span><span class="o">][</span><span class="s1">&#39;conf_dir&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;bb&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="ss">chef</span><span class="p">:</span><span class="n">attributes</span> <span class="o">&gt;</span> <span class="nb">puts</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;haproxy&#39;</span><span class="o">][</span><span class="s1">&#39;conf_dir&#39;</span><span class="o">]</span>
</span><span class='line'><span class="n">bb</span>
</span><span class='line'><span class="ss">chef</span><span class="p">:</span><span class="n">attributes</span> <span class="o">&gt;</span> <span class="nb">puts</span> <span class="n">node</span><span class="o">[</span><span class="ss">:haproxy</span><span class="o">][</span><span class="ss">:conf_dir</span><span class="o">]</span>
</span><span class='line'><span class="n">aa</span>
</span></code></pre></td></tr></table></div></figure>


<p>위와 같이 <code>string</code>으로 된 hash와 <code>symbol</code>로 된 hash의 값이 merge가 안되는 문제이다.</p>

<p>chef 11까지는 아래와 같이 둘중 어떤 것을 사용해도 같은 변수로 관리됐다.</p>

<figure class='code'><figcaption><span>chef11</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">chef</span> <span class="o">&gt;</span> <span class="n">attributes_mode</span>
</span><span class='line'><span class="ss">chef</span><span class="p">:</span><span class="n">attributes</span> <span class="o">&gt;</span> <span class="n">default</span><span class="o">[</span><span class="s1">&#39;haproxy&#39;</span><span class="o">][</span><span class="s1">&#39;conf_dir&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;aa&#39;</span>
</span><span class='line'><span class="ss">chef</span><span class="p">:</span><span class="n">attributes</span> <span class="o">&gt;</span> <span class="nb">puts</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;haproxy&#39;</span><span class="o">][</span><span class="s1">&#39;conf_dir&#39;</span><span class="o">]</span>
</span><span class='line'><span class="n">aa</span>
</span><span class='line'><span class="ss">chef</span><span class="p">:</span><span class="n">attributes</span> <span class="o">&gt;</span> <span class="nb">puts</span> <span class="n">node</span><span class="o">[</span><span class="ss">:haproxy</span><span class="o">][</span><span class="ss">:conf_dir</span><span class="o">]</span>
</span><span class='line'><span class="n">aa</span>
</span><span class='line'>
</span><span class='line'><span class="ss">chef</span><span class="p">:</span><span class="n">attributes</span> <span class="o">&gt;</span> <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="o">[</span><span class="s1">&#39;haproxy&#39;</span><span class="o">][</span><span class="s1">&#39;conf_dir&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;bb&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="ss">chef</span><span class="p">:</span><span class="n">attributes</span> <span class="o">&gt;</span> <span class="nb">puts</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;haproxy&#39;</span><span class="o">][</span><span class="s1">&#39;conf_dir&#39;</span><span class="o">]</span>
</span><span class='line'><span class="n">bb</span>
</span><span class='line'><span class="ss">chef</span><span class="p">:</span><span class="n">attributes</span> <span class="o">&gt;</span> <span class="nb">puts</span> <span class="n">node</span><span class="o">[</span><span class="ss">:haproxy</span><span class="o">][</span><span class="ss">:conf_dir</span><span class="o">]</span>
</span><span class='line'><span class="n">bb</span>
</span></code></pre></td></tr></table></div></figure>


<p>옛날 부터 <a href="http://www.foodcritic.io/#FC019">foodcritic에서도 둘중에 한 포맷으로 정해서 사용하라는 룰</a>이 있었지만 정리를 안했더니 이런 일이 생긴건가 라고 반성을 하면서..
(사실 현재도 안돌리고 있긴한.. 안돌리다 돌리려니 너무 고칠게 많아서 차라리 리팩토링 하고 돌려야지 하다보니&hellip;.. ㅠㅠ)</p>

<p>그렇다면 어느쪽으로 style을 모는게 좋을까&hellip;??</p>

<h2>string vs symbol (for node attribute style)</h2>

<blockquote><p>개인적으로나 chef에서는 string을 선호</p></blockquote>

<p>물론 사실 개인적인 생각엔 아직까지도 어느정도 취향(?)의 영역이 있다.
foodcritic(chef lint tool)에서는 <a href="http://www.foodcritic.io/#FC001">string을 사용을 규정</a>하고는 있긴하다.
하지만 아래와 같이 빼고 사용하면 그만인 부분이다.</p>

<figure class='code'><figcaption><span>rule FC001</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>foodcritic -t ~FC001 .
</span></code></pre></td></tr></table></div></figure>


<p>그렇다면 사용자들이 선호하는 것은 어떨까? <br/>
아래와 같이 3종류의 attribute 사용법에 대한 <a href="https://www.evernote.com/shard/s5/sh/1fc5a0c9-bdd0-44f4-8f5a-ed2ddc9d2cfd/a13f36acd7cfa2a468f7829e5549209f">user survey</a>에 대한 조사는 아래와 같이 symbol이 우세하다.
<img src="/images/fc001-survey-20121029-144804.jpg" width="1524"></p>

<p>그리고 실제 <a href="https://github.com/bbatsov/ruby-style-guide">ruby style guide</a>에서도 물론 특정한 규정은 없어서.. <br/>
그렇다고 괜히 <code>string</code>을 선호하는 건 아니다. 자세한 이유는 <a href="https://github.com/acrmp/foodcritic/issues/1">여기1</a> <a href="https://github.com/acrmp/foodcritic/issues/86">여기2</a> 를 읽어 보면 도움이 될듯 하다.</p>

<h2>그래서 내 recipe를 지금이라도 당장 다 뜯어 고쳐야 하는건가요?</h2>

<blockquote><p>아니요</p></blockquote>

<p>위의 style 문제는 사실 feature가 아닌 bug 이다. (<a href="https://github.com/chef/chef/commit/097d5eb1bf4b3cbcc9bfc937c5e3441dee5c9f5c">이때 추가된..</a>)</p>

<p><a href="https://github.com/chef/chef/pull/2753">deep_merge_cache fixes for bugs in 12.0.0</a></p>

<p>22일 전에 이미 패치는 된 상태이나 chef 11에 대해 followup하느라 12.1.0이 나오질 않고 있는것 같다. <br/>
그렇기 때문에 chef-client를 12.0.0 이상으로 쓸 생각이라면 잠깐 보류하는게 좋을듯 하다.</p>

<p>하지만 이번 기회에 이런 문제를 야기 할 수 있는 <code>symbol</code>을 <code>string</code>으로 바꿔야 하지 않을까하는 교훈(?)을 주는 일이지 않을까 싶다.</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-02-05T17:21:56+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/attribute/'>attribute</a>, <a class='category' href='/blog/categories/chef-12/'>chef 12</a>, <a class='category' href='/blog/categories/hash/'>hash</a>, <a class='category' href='/blog/categories/string/'>string</a>, <a class='category' href='/blog/categories/symbol/'>symbol</a>


</div>
	
	<div class="comments"><a href="#disqus_thread">Comments</a></div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
		
		
		<a class="addthis_button_tweet"></a>
		
		
		
	</div>
	
</div>



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2018

    leoh0

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'leoh0githubio';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://leoh0.github.io/blog/2015/02/05/chef-12-feature-or-bug/';
        var disqus_url = 'http://leoh0.github.io/blog/2015/02/05/chef-12-feature-or-bug/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-46519012-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>